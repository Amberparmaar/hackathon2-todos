# Implementation Plan: Phase II Full-Stack Multi-User Web Application

**Branch**: `001-phase2-fullstack`
**Date**: 2026-01-07
**Spec**: [spec.md](./spec.md)

## Summary

Transform Phase I in-memory console app into a fully functional, multi-user web application with persistent storage and secure JWT authentication. All CRUD operations must enforce user isolation with Next.js frontend, FastAPI backend, and Neon PostgreSQL database.

## Technical Context

**Language/Version**: TypeScript (Next.js 16+), Python 3.11+ (FastAPI)
**Primary Dependencies**: Next.js 16+ (App Router), FastAPI, SQLModel, Neon PostgreSQL (psycopg2), Better Auth (JWT), PyJWT, bcrypt, Tailwind CSS
**Storage**: Neon Serverless PostgreSQL with user and task tables
**Testing**: pytest (backend), Jest/React Testing Library (frontend), Playwright (E2E)
**Target Platform**: Web application with separated frontend and backend
**Performance Goals**: 1000 concurrent users, < 500ms API response time, < 3 second page load time
**Constraints**: Zero manual coding - all code generated via agents/skills, JWT-based stateless authentication, strict multi-user isolation
**Scale/Scope**: Medium complexity - full CRUD operations + authentication + persistence

## Constitution Check

**STATUS: ✅ PASS - All constitution gates validated**

| Requirement | Constitution Principle | Status |
|-------------|----------------------|--------|
| Spec-Driven Development | Principle I | ✅ PASS - Spec complete at [spec.md](./spec.md) |
| Zero Manual Coding | Principle II | ✅ PASS - All code will be generated via agents |
| Phase-by-Phase Progression | Principle III | ✅ PASS - Building on Phase I foundation |
| Tech Stack Compliance | Principle V | ✅ PASS - Using mandated Phase II stack |
| User Isolation (from Phase II) | Principle VI | ✅ PASS - JWT auth specified |
| Monorepo Phase Isolation | Principle VII | ✅ PASS - Using isolated phase2/ folder |
| Documentation Excellence | Principle VIII | ✅ PASS - Will document all changes |

## Project Structure

### Documentation (this feature)

```text
specs/001-phase2-fullstack/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 output (not needed - no clarifications)
├── data-model.md         # Phase 1 output
├── contracts/            # Phase 1 output (API contracts)
├── quickstart.md          # Phase 1 output (development guide)
├── checklists/
│   └── requirements.md  # Validation checklist (complete)
└── tasks.md             # Will be generated by /sp.tasks
```

### Source Code (phase2/)

```text
phase2/
├── specs/
│   ├── specify.md        # Reference spec
│   ├── plan.md           # This plan
│   └── tasks.md          # Atomic tasks (to be generated)
├── frontend/              # Next.js 16+ App Router
│   ├── src/
│   │   ├── app/           # App Router pages
│   │   │   ├── page.tsx        # Root layout
│   │   │   ├── signin/page.tsx
│   │   │   └── dashboard/page.tsx
│   │   ├── components/     # Reusable UI components
│   │   │   ├── TaskCard.tsx
│   │   │   ├── TaskForm.tsx
│   │   │   ├── ProtectedRoute.tsx
│   │   │   └── AuthProvider.tsx
│   │   ├── lib/            # Utilities
│   │   │   ├── api.ts       # API client with JWT handling
│   │   │   └── auth.ts      # Token storage/validation
│   │   └── types/          # TypeScript types
│   ├── package.json        # Dependencies
│   ├── tailwind.config.js  # Tailwind configuration
│   ├── next.config.js      # Next.js configuration
│   └── tsconfig.json       # TypeScript configuration
├── backend/               # FastAPI + SQLModel
│   ├── src/
│   │   ├── models/         # SQLModel database models
│   │   │   ├── user.py      # User model (or use Better Auth table)
│   │   │   └── task.py     # Task model with user_id FK
│   │   ├── api/            # API routes
│   │   │   ├── auth.py      # Signup, sign-in, sign-out endpoints
│   │   │   └── tasks.py     # CRUD operations with user isolation
│   │   ├── core/           # Business logic
│   │   │   ├── security.py  # JWT validation and user extraction
│   │   │   └── database.py  # Database connection and session
│   │   └── schemas/        # Pydantic schemas
│   │       ├── user.py
│   │       └── task.py
│   ├── main.py             # FastAPI application entry point
│   ├── requirements.txt   # Python dependencies
│   └── Dockerfile          # Backend containerization
├── CLAUDE.md             # Phase-specific instructions
└── README.md              # Setup and usage guide
```

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|------------|------------|------------------------------------|
| N/A | N/A | N/A |

## Phase 0: Research & Analysis

**STATUS: ✅ COMPLETE - No [NEEDS CLARIFICATION] markers in spec**

All technical decisions are clearly specified in the user input and existing specifications. No research phase required as:

- Tech stack is mandated (Next.js 16+, FastAPI, SQLModel, Neon, Better Auth JWT)
- Database schema is defined (User + Task entities)
- API patterns are standard RESTful
- Authentication flow is stateless JWT-based
- User isolation is explicitly required

Proceeding directly to design phase.

## Phase 1: Design & Contracts

### Database Schema Design

**File**: `specs/001-phase2-fullstack/data-model.md`

#### User Entity

```python
# User model (or use Better Auth's user table if available)
- id: UUID (primary key)
- email: string (unique, indexed)
- password_hash: string (bcrypt hashed)
- created_at: timestamp
```

#### Task Entity

```python
# Task model
- id: UUID (primary key)
- title: string (1-200 characters, required)
- description: string (max 1000 characters, optional)
- completed: boolean (default False)
- user_id: UUID (foreign key to User, indexed)
- created_at: timestamp (auto-generated)
- completed_at: timestamp (nullable, set on completion toggle)
```

#### Relationships

- User (1) ──── (N) Tasks (one-to-many)
- Task (N) ──── (1) User (many-to-one)

#### Constraints

- Cascade delete: Tasks deleted when User deleted
- Foreign key constraint: user_id must reference existing User
- Unique constraint: email addresses unique across all users
- Index: user_id index on Tasks for fast filtering

### API Contracts

**File**: `specs/001-phase2-fullstack/contracts/openapi.yaml`

#### Authentication Endpoints

```yaml
POST   /api/auth/signup   # Create new user
POST   /api/auth/signin   # Exchange credentials for JWT
POST   /api/auth/signout   # Invalidate token (client-side)
```

#### Task CRUD Endpoints

```yaml
POST   /api/tasks           # Create task (requires JWT)
GET    /api/tasks           # List tasks (filtered by user_id)
GET    /api/tasks/{id}      # Get specific task (verify ownership)
PUT    /api/tasks/{id}      # Update task (verify ownership)
DELETE /api/tasks/{id}      # Delete task (verify ownership)
PATCH   /api/tasks/{id}/toggle # Toggle completion (verify ownership)
```

#### Response Codes

```yaml
200: Success
201: Resource created
401: Unauthorized (missing/invalid JWT)
403: Forbidden (not task owner)
404: Resource not found
422: Validation error
500: Server error
```

### Quickstart Guide

**File**: `specs/001-phase2-fullstack/quickstart.md`

#### Development Environment Setup

```bash
# Backend setup
cd phase2/backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
export DATABASE_URL="postgresql://user:pass@host:port/db"
export BETTER_AUTH_SECRET="my-super-secret-phase2-key-2026"

# Frontend setup
cd phase2/frontend
npm install
# Configure backend URL in .env.local
NEXT_PUBLIC_API_URL="http://localhost:8000"
NEXT_PUBLIC_AUTH_SECRET="my-super-secret-phase2-key-2026"

# Run backend
cd backend
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000

# Run frontend (new terminal)
cd frontend
npm run dev
```

#### Verification Steps

1. Backend health check: `curl http://localhost:8000/health`
2. Create test user: POST to `/api/auth/signup`
3. Sign in and receive JWT
4. Create task with JWT in Authorization header
5. Verify task appears in user's list
6. Sign out as second user, verify cannot access first user's tasks
7. Test all CRUD operations with ownership validation

## Agent/Skill Delegation Strategy

### Primary Approach: Orchestrator Agent

**Recommended**: Delegate entire Phase II implementation to orchestrator agent
**Agent**: `@agents/orchestrator-agent.yaml`
**Rationale**: Orchestrator coordinates auth, backend, and frontend agents, ensuring proper integration and adherence to reusable patterns.

### Fallback: Direct Skill Invocation

**Alternative**: Invoke master skill directly
**Skill**: `@skills/phase2-fullstack.yaml`
**Rationale**: If orchestrator unavailable, use master skill that orchestrates all components.

### Responsibility Breakdown

| Component | Primary Agent/Skill | Fallback |
|-----------|-------------------|-----------|
| **Authentication** | `@agents/auth-agent.yaml` or `@skills/better-auth-jwt.yaml` | `@skills/phase2-fullstack.yaml` |
| **Database Models** | `@agents/backend-agent.yaml` (SQLModel) | `@skills/neon-sqlmodel.yaml` |
| **Task CRUD API** | `@agents/backend-agent.yaml` (FastAPI) + `@skills/multi-user-crud.yaml` | `@skills/phase2-fullstack.yaml` |
| **Frontend UI** | `@agents/frontend-agent.yaml` (Next.js) + `@skills/nextjs-task-ui.yaml` | `@skills/phase2-fullstack.yaml` |

## Execution Sequence

### Step 1: Database Schema and Connection

**Agent**: `@agents/backend-agent.yaml` or `@skills/neon-sqlmodel.yaml`
**Tasks**:
- Create User model (or integrate Better Auth)
- Create Task model with user_id foreign key
- Establish database connection module
- Create initial migration script
- Add environment configuration template
**Deliverables**:
- `phase2/backend/src/models/user.py`
- `phase2/backend/src/models/task.py`
- `phase2/backend/src/core/database.py`
- `phase2/backend/.env.example`

### Step 2: Authentication System (Frontend + Backend)

**Agents**:
- Backend: `@agents/auth-agent.yaml` or `@skills/better-auth-jwt.yaml`
- Frontend: `@agents/frontend-agent.yaml` (auth pages)
**Tasks**:
**Backend**:
- Implement JWT generation on sign-in
- Implement JWT validation middleware
- Create signup endpoint (user creation + hashing)
- Create sign-in endpoint (credential validation + JWT)
- Configure BETTER_AUTH_SECRET environment variable
**Frontend**:
- Create sign-in page
- Create signup page
- Implement token storage (localStorage/cookies)
- Implement JWT attachment to API requests
- Create auth context/provider
**Deliverables**:
- `phase2/backend/src/api/auth.py`
- `phase2/backend/src/core/security.py`
- `phase2/frontend/src/app/signin/page.tsx`
- `phase2/frontend/src/app/signup/page.tsx`
- `phase2/frontend/src/lib/auth.ts`
- `phase2/frontend/src/components/AuthProvider.tsx`

### Step 3: Task Model with User Ownership

**Agent**: `@agents/backend-agent.yaml` (SQLModel)
**Tasks**:
- Define Task SQLModel with all fields
- Add user_id foreign key relationship
- Create Pydantic schemas for validation
- Implement database CRUD operations
- Add ownership validation logic
**Deliverables**:
- `phase2/backend/src/models/task.py`
- `phase2/backend/src/schemas/task.py`

### Step 4: Secure CRUD Routes with Ownership Checks

**Agent**: `@agents/backend-agent.yaml` + `@skills/multi-user-crud.yaml`
**Tasks**:
- Create task list endpoint (filter by user_id from JWT)
- Create create task endpoint (validate JWT ownership)
- Create update task endpoint (verify ownership before update)
- Create delete task endpoint (verify ownership before delete)
- Create toggle completion endpoint (verify ownership before toggle)
- Implement error handling (401, 403, 404, 422)
- Add request logging for audit
**Deliverables**:
- `phase2/backend/src/api/tasks.py`
- `phase2/backend/src/main.py` (route registration)

### Step 5: Frontend Protected Routes and API Client

**Agent**: `@agents/frontend-agent.yaml` + `@skills/nextjs-task-ui.yaml`
**Tasks**:
- Create API client module
- Implement JWT injection in Authorization header
- Create protected route wrapper (middleware)
- Create task list page
- Create task card component
- Create add task form/modal
- Implement error handling (401 redirects to sign-in, 403 shows forbidden)
- Add loading states
**Deliverables**:
- `phase2/frontend/src/lib/api.ts`
- `phase2/frontend/src/components/ProtectedRoute.tsx`
- `phase2/frontend/src/components/TaskCard.tsx`
- `phase2/frontend/src/components/TaskForm.tsx`
- `phase2/frontend/src/app/dashboard/page.tsx`

### Step 6: Task List UI with Add/Edit/Delete

**Agent**: `@agents/frontend-agent.yaml` + `@skills/nextjs-task-ui.yaml`
**Tasks**:
- Implement task list layout (responsive)
- Add edit functionality to task cards
- Add delete confirmation
- Implement completion toggle UI
- Style with Tailwind CSS
- Add empty state message
- Add success/error toasts
- Optimize for mobile performance
**Deliverables**:
- `phase2/frontend/src/components/TaskList.tsx`
- Complete dashboard page integration
- Tailwind styling applied

### Step 7: End-to-End Testing Strategy

**Tasks**:
- Create multi-user isolation test suite
- Test JWT authentication flow (signup → sign-in → API calls → sign-out)
- Test unauthorized access attempts (401, 403)
- Test data persistence across sessions
- Test concurrent user scenarios
- Test responsive UI on different screen sizes
- Verify performance benchmarks
**Deliverables**:
- `phase2/backend/tests/` (pytest tests)
- `phase2/frontend/tests/` (Jest tests)
- Test execution report
- Performance metrics

## Validation & Iteration Plan

### Testing Strategy

**Multi-User Isolation Testing**:
1. Create User A and User B accounts
2. Sign in as User A, create tasks
3. Sign out, sign in as User B
4. Verify User B cannot see User A's tasks
5. Verify User B cannot modify User A's tasks
6. Attempt direct API access to User A's task ID as User B → expect 403

**JWT Flow Testing**:
1. Sign in with valid credentials → verify JWT returned
2. Use JWT to create task → verify success
3. Use JWT to list tasks → verify user_id filtering
4. Attempt to use invalid/expired JWT → expect 401
5. Sign out → verify token invalidation
6. Attempt to use token after sign-out → expect 401

**Common Failure Points & Triggers**

| Failure Point | Expected Behavior | Refinement Trigger |
|---------------|------------------|-------------------|
| JWT not attached to request | 401 Unauthorized | Check API client middleware |
| Wrong user_id in JWT | Tasks filtered incorrectly | Verify JWT extraction logic |
| Ownership check bypassed | Can access others' tasks | Verify ownership validation in every route |
| Token not persisted | Lost auth on page refresh | Check token storage implementation |
| Database connection fails | 500 errors | Verify error handling and retry logic |

### Success Criteria for Phase II Completion

- [ ] All authentication endpoints working (signup, sign-in, sign-out)
- [ ] JWT tokens issued and validated correctly
- [ ] All CRUD operations functional (create, read, update, delete, toggle)
- [ ] User isolation enforced on all operations
- [ ] Protected routes redirect unauthenticated users
- [ ] Task list UI responsive on all devices
- [ ] Database persists data correctly
- [ ] Multi-user isolation tests pass (100%)
- [ ] JWT flow tests pass (100%)
- [ ] Performance benchmarks met (< 500ms API, < 3s UI load)
- [ ] Zero manual code written
- [ ] Reusable agents/skills used
- [ ] All code comments reference Task IDs

## Deliverables Confirmation

### GitHub Repo Structure

```text
phase2/
├── frontend/
│   ├── src/
│   │   ├── app/
│   │   ├── components/
│   │   ├── lib/
│   │   └── types/
│   ├── package.json
│   ├── next.config.js
│   └── tailwind.config.js
├── backend/
│   ├── src/
│   │   ├── models/
│   │   ├── api/
│   │   ├── core/
│   │   └── schemas/
│   ├── tests/
│   ├── main.py
│   ├── requirements.txt
│   └── Dockerfile
├── specs/
│   ├── specify.md
│   ├── plan.md
│   └── tasks.md
├── CLAUDE.md
└── README.md
```

### Deployment Readiness

**Frontend (Vercel)**:
- [ ] `.env.local` configured
- [ ] Build command: `npm run build`
- [ ] Output in `.next/` folder
- [ ] Static export configured if needed
- [ ] Vercel deployment instructions in README

**Backend (Docker/Local)**:
- [ ] Dockerfile created
- [ ] Environment variables documented in `.env.example`
- [ ] Run command: `docker-compose up` or `uvicorn src.main:app`
- [ ] Health check endpoint available
- [ ] API documentation (OpenAPI/Swagger) accessible

### Demo Flow (< 90 seconds)

1. **00:00-00:15**: Sign up as User A
2. **00:00-00:30**: Sign in as User A, receive JWT
3. **00:00-00:45**: Create 3 tasks
4. **00:01:00**: Sign out
5. **00:01:15**: Sign in as User B
6. **00:01:30**: Create 2 different tasks
7. **00:01:45**: Sign out, verify User A's tasks still exist
8. **00:02:00**: Sign back in as User A, verify User B's tasks not visible
9. **00:02:15**: Edit a task, mark complete
10. **00:02:30**: Delete a task
11. **00:02:45**: Final task count verification

## Bonus Maximization

**Goal**: Maximize +200 bonus points for Reusable Intelligence

### Reusable Agents Usage

| Agent | Purpose | Usage Frequency |
|-------|-----------|----------------|
| `@agents/orchestrator-agent.yaml` | Coordinate entire Phase II implementation | Primary |
| `@agents/auth-agent.yaml` | Authentication system | One-time |
| `@agents/backend-agent.yaml` | FastAPI + SQLModel models | Multiple (auth + CRUD) |
| `@agents/frontend-agent.yaml` | Next.js UI components | Multiple |

### Reusable Skills Usage

| Skill | Purpose | Usage Frequency |
|-------|-----------|----------------|
| `@skills/better-auth-jwt.yaml` | JWT auth implementation | One-time |
| `@skills/multi-user-crud.yaml` | User-isolated CRUD | One-time |
| `@skills/neon-sqlmodel.yaml` | Neon database setup | One-time |
| `@skills/nextjs-task-ui.yaml` | Responsive UI components | One-time |

### Documentation of Agent Delegation

All agent invocations will be documented in:
- Phase2 `implement.md` with timestamps and agent IDs
- Code comments referencing specific agents/skills used
- Git commit messages including agent references

---

**Status**: ✅ PLAN COMPLETE - Ready for `/sp.tasks` to generate atomic task breakdown
